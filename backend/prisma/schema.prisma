datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String    @id @default(uuid())
  pubkey    String    @unique
  reputation Float    @default(0.0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sessions  Session[]
}

model Agent {
  id            String    @id @default(uuid())
  pubkey        String    @unique
  apiKey        String    @unique @default(uuid())  // API key for authentication
  name          String?                              // Display name
  webhookUrl    String?                              // Webhook endpoint for events
  builderCode   String?                              // Genesis builder code
  tier          String    @default("anonymous")     // anonymous, verified, enterprise
  escrowBalance Int       @default(0)               // Virtual escrow in micros (for sandbox)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  bids          Bid[]
}

// Builder code registry for genesis fee sharing
model BuilderCode {
  id              String    @id @default(uuid())
  code            String    @unique                 // e.g., "langchain", "autogen"
  builderPubkey   String                            // Payout wallet
  revenueShareBps Int       @default(5000)          // Basis points (5000 = 50%)
  tier            String    @default("pending")     // pending, genesis, standard
  totalVolume     BigInt    @default(0)             // Lifetime volume in micros
  createdAt       DateTime  @default(now())
  approvedAt      DateTime?
}

// Platform configuration
model PlatformConfig {
  id        String   @id @default("singleton")
  mode      String   @default("beta")              // beta, hybrid, live
  updatedAt DateTime @updatedAt
}

model Session {
  id               String    @id @default(uuid())
  userPubkey       String
  user             User      @relation(fields: [userPubkey], references: [pubkey])
  priceFloor       Int       // Micro-USDC per second
  deviceAttestation String?
  connected        Boolean   @default(false)
  active           Boolean   @default(true)
  createdAt        DateTime  @default(now())
  endedAt          DateTime?
  matches          Match[]
}

model Bid {
  id                  String    @id @default(uuid())
  agentPubkey         String?   
  agent               Agent?    @relation(fields: [agentPubkey], references: [pubkey])
  maxPricePerSecond   Int
  requiredAttentionScore Float
  targetUrl           String?
  contentUrl          String?   // URL to uploaded creative asset (image/video)
  contentStatus       String    @default("pending") // pending, approved, flagged, rejected
  expiry              DateTime
  active              Boolean   @default(true)
  createdAt           DateTime  @default(now())
  
  // New Fields for Reservation Flow
  targetQuantity      Int       @default(1)
  durationPerUser     Int       @default(10) // Seconds
  validationQuestion  String?
  matches             Match[]
}

model Match {
  id        String   @id @default(uuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id])
  bidId     String
  bid       Bid      @relation(fields: [bidId], references: [id])
  status    String   @default("offered") // offered, active, completed, failed, rejected
  
  startTime DateTime @default(now())
  endTime   DateTime?
  
  // Validation & Completion Tracking
  validationAnswer       String?   // Human's text answer to validation question
  validationSubmittedAt  DateTime? // When human submitted answer
  validationResult       String?   // Agent's verdict: "approved" | "rejected" | "pending"
  completedAt            DateTime? // When session ended
  humanExitedEarly       Boolean   @default(false) // Did human exit before timer?
  actualDuration         Int?      // Actual seconds spent (vs expected)
  
  settlements Settlement[]
}

model Settlement {
  id              String   @id @default(uuid())
  matchId         String
  match           Match    @relation(fields: [matchId], references: [id])
  amount          Int      // Micro-USDC
  transactionSig  String?
  status          String   @default("pending") // pending, confirmed, failed
  timestamp       DateTime @default(now())
}

