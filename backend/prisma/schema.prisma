datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String    @id @default(uuid())
  pubkey    String    @unique
  reputation Float    @default(0.0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sessions  Session[]
}

model Agent {
  id        String    @id @default(uuid())
  pubkey    String    @unique
  createdAt DateTime  @default(now())
  bids      Bid[]
}

model Session {
  id               String    @id @default(uuid())
  userPubkey       String
  user             User      @relation(fields: [userPubkey], references: [pubkey])
  priceFloor       Int       // Micro-USDC per second
  deviceAttestation String?
  connected        Boolean   @default(false)
  active           Boolean   @default(true)
  createdAt        DateTime  @default(now())
  endedAt          DateTime?
  matches          Match[]
}

model Bid {
  id                  String    @id @default(uuid())
  agentPubkey         String?   
  agent               Agent?    @relation(fields: [agentPubkey], references: [pubkey])
  maxPricePerSecond   Int
  requiredAttentionScore Float
  targetUrl           String?
  expiry              DateTime
  active              Boolean   @default(true)
  createdAt           DateTime  @default(now())
  
  // New Fields for Reservation Flow
  targetQuantity      Int       @default(1)
  durationPerUser     Int       @default(10) // Seconds
  validationQuestion  String?
  matches             Match[]
}

model Match {
  id        String   @id @default(uuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id])
  bidId     String
  bid       Bid      @relation(fields: [bidId], references: [id])
  status    String   @default("offered") // offered, active, completed, failed, rejected
  
  startTime DateTime @default(now())
  endTime   DateTime?
  
  validationAnswer Boolean? // New: Q&A Response
  settlements Settlement[]
}

model Settlement {
  id              String   @id @default(uuid())
  matchId         String
  match           Match    @relation(fields: [matchId], references: [id])
  amount          Int      // Micro-USDC
  transactionSig  String?
  status          String   @default("pending") // pending, confirmed, failed
  timestamp       DateTime @default(now())
}

